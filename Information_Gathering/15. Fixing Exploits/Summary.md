# Content

- [Content](#content)
  - [Fixing Memory Corruption Exploits](#fixing-memory-corruption-exploits)
    - [Importing and Examining the Exploit](#importing-and-examining-the-exploit)
      - [The way to work](#the-way-to-work)
      - [Demo](#demo)
    - [Cross-Compiling Exploit Code](#cross-compiling-exploit-code)
      - [The way to work](#the-way-to-work-1)
      - [Demo](#demo-1)
    - [Changing the Socket Information](#changing-the-socket-information)
      - [The way to work](#the-way-to-work-2)
      - [Demo](#demo-2)
    - [Changing the Return Address](#changing-the-return-address)
  - [Fixing Web Exploits](#fixing-web-exploits)
    - [Selecting the Vulnerability](#selecting-the-vulnerability)
    - [Changing Connectivity Information](#changing-connectivity-information)

  
## Fixing Memory Corruption Exploits

- When using public exploits, we may encounter problems such as incompatibility with the target's operating system and architecture, or need to change to fit our needs. Understanding the basic parameters of an exploit such as socket information, return address, payload and offsets is very important for successful modification. In addition, the use of additional libraries and the ability to convert exploits to different platforms also increase the flexibility and efficiency of the attack process.

### Importing and Examining the Exploit

#### The way to work

- Importing and Exploring the Exploit is the process of finding and reviewing exploit code to understand how it works and identify points that users can customize to suit the attack environment.
- After understanding how the exploit code works, users can copy it to their personal computer and edit it at will to optimize its features and be suitable for attack purposes. its own merit. The user can then recompile to generate a new version of the exploit code and use it in the attack.

#### Demo

- We will again target Sync Breeze Enterprise 10.0.28 - a data synchronization software for computers running Windows operating system. It is used to synchronize data between folders and network folders on various computers.
- First we will searchsploit to find the exploit for this software.
  ![Picture](../15.%20Fixing%20Exploits/Image/1.png)
- To begin the process of modifying our exploit, we will move the target exploit to our current working directory by using SearchSploit’s handy -m mirror (copy) option.
  ![Picture](../15.%20Fixing%20Exploits/Image/2.png)

### Cross-Compiling Exploit Code

#### The way to work

- Cross-compiler is a tool that allows to compile the source code of one system that has been coded to run on another system. 
- With cross-compiler, users can compile exploit code to run on another target system without the need for computers or compiling tools for that system.
- The mechanism of cross-compiler operation is to use a host compiler to generate include files and link libraries for the target architecture. The cross-compiler then uses these files to compile the source code into binaries corresponding to the target architecture.
- To do this, the cross-compiler needs to be configured to know the architecture, memory, and command details of the target operating system. These parameters are provided in the cross-compiler's configuration file, which helps it to understand the conventions of the target operating system and generate the corresponding binaries.

#### Demo

- We will use the extremely popular mingw-64 cross-compiler. 
- Mingw-w64 (Minimalist GNU for Windows) is an open source software development toolkit, designed to allow programmers to create applications that run on the Windows operating system with the support of libraries. C and C++, no need to use Microsoft-specific libraries.
  ![Picture](../15.%20Fixing%20Exploits/Image/3.png)
- After the installation has completed, we can use mingw-64 to compile the code into a Windows PE file.
  ```
  i686-w64-mingw32-gcc 42341.c -o syncbreeze_exploit.exe -lws2_32
  ```
  - In this example, the user is using a cross-compiler named "i686-w64-mingw32-gcc" to compile a source code file named "42341.c" into a binary file that runs on Windows and named it "syncbreeze_exploit.exe".
  - The parameters in the cross-compiler name "i686-w64-mingw32-gcc" were specified so that it knows the target operating system and architecture.
    - Where, "i686" refers to the processor architecture.
    - "w64" refers to the 64-bit version of Windows.
    - "mingw32" refers to the version of Windows that is using MinGW (Minimalist GNU for Windows) as its environment. 
    - "-lws2_32" specifies the use of the ws2_32.lib library, a support library for networking-related applications on Windows.
  ![Picture](../15.%20Fixing%20Exploits/Image/4.png)

### Changing the Socket Information

#### The way to work

- We already know that this exploit targets a remotely-accessible vulnerability, which means that our code needs to establish a connection to the target at some point.

#### Demo

- We have a sample code C that it uses hard-coded values for the IP address. 
  ![Picture](../15.%20Fixing%20Exploits/Image/5.png)
- So if we want to use the code, we must change the information about the target machine.
  ```cpp
  printf("[>] Socket created.\n");
  server.sin_addr.s_addr = inet_addr("192.168.50.10");
  server.sin_family = AF_INET;
  server.sin_port = htons(4444);
  ```

### Changing the Return Address

- Analyzed the source code of an exploit program and found that the program used a return address found in the DLL file msvbvm60.dll, and not the vulnerable software. gap. However, when checking the loaded modules in the Windows client, we find that this DLL is not present, which means the return address will be invalid for our target.
- So, to modify the exploit, we need to change the return address to a valid one of our own. To find a valid return address, one can do the following: create the target environment on the local computer and use a debugging tool to determine the return address; or use information from other public exploits to find a return address that matches our target environment. Alternatively, one can find the return address directly from the target computer by copying the DLL files and using tools like disassembler or msfpescan384 from the Metasploit Framework to find the return address.

## Fixing Web Exploits

### Selecting the Vulnerability

- Let’s consider the following scenario. During an assessment we discover a Linux host that has an apache2 server exposed. 
- After enumerating the web server, we find an installation of CMS Made Simple version 2.2.5 listening on TCP port 443. This version appears to be vulnerable to remote code execution and a public exploit is available on Exploit-DB.
- This vulnerability is post-authentication, however, we discovered valid application credentials (admin / HUYfaw763) on another machine during the enumeration process.
  ![Picture](../15.%20Fixing%20Exploits/Image/6.png)

### Changing Connectivity Information

- We realize the base_url variable needs to be changed to match our environment.
  ```
  base_url = "https://192.168.50.10/admin"
  ```
  ![Picture](../15.%20Fixing%20Exploits/Image/7.png)
- We will see an SSL certificate validation error on a specific site and a workaround in the exploit code. The exploit uses the Python requests library to interact with the target via three POST requests. However, when making this request, a SEC_ERROR_UNKNOWN_ISSUER393 error may occur because the certificate is not validated. To work around this issue, the exploit uses the verify=False parameter to bypass the SSL certificate validation check.
  ```
  response = requests.post(url, data=data, allow_redirects=False, verify=False)
  response = requests.post(url, data=data, files=txt, cookies=cookies, verify=False)
  response = requests.post(url, data=data, cookies=cookies, allow_redirects=False,  verify=False)
  ```
  ![Picture](../15.%20Fixing%20Exploits/Image/8.png)
  ![Picture](../15.%20Fixing%20Exploits/Image/9.png)
  ![Picture](../15.%20Fixing%20Exploits/Image/10.png)
- Finally, we also need to change the credentials used in the original exploit to match those found during the enumeration process.
  ![Picture](../15.%20Fixing%20Exploits/Image/11.png)
